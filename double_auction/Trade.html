{% extends "Base.html" %}
{% set buttons = False %}


{% block head %}

<style>
.offerbox {
    height: 100px;
}
</style>

{% endblock head %}


{% block main %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Trading Page</h3>
    <button type="button" class="btn btn-outline-uproot btn-sm" data-bs-toggle="modal" data-bs-target="#instructionsModal">
        View Instructions
    </button>
</div>

<p>{% if player.buyer %}You are a <b>buyer</b> with valuation <b>${{ player.cost_or_value | to(2) }}</b>.{% else %}You are a <b>seller</b> with cost <b>${{ player.cost_or_value | to(2) }}</b>.{% endif %}</p>


<div id="not-traded" role="region" aria-label="Trading controls">
    <h3 class="mt-4">{% if player.buyer %}Price you are willing to pay{% else %}Price you are willing to accept{% endif %}</h3>

    <p class="no-offer" aria-live="polite">You do not have a current offer.</p>

    <p class="has-offer" aria-live="polite">Your current offer is <b>$<span id="current-offer"></span></b>.</p>

    <div class="mt-3">
        <div class="w-25 mb-3 input-group">
            <label for="amount" class="visually-hidden">{% if player.buyer %}Bid price{% else %}Ask price{% endif %}</label>
            <span class="input-group-text">$</span>
            <input id="amount" type="number" class="form-control" step="0.01" min="0" placeholder="0.00" aria-label="{% if player.buyer %}Price you are willing to pay{% else %}Price you are willing to accept{% endif %}">
        </div>

        <button class="btn btn-uproot" type="button" onclick="makeOffer(true)" aria-label="Submit new {% if player.buyer %}bid{% else %}ask{% endif %} offer">Submit new offer</button>
        <button class="has-offer btn btn-outline-uproot" type="button" onclick="makeOffer(false)" aria-label="Cancel your current offer">Cancel current offer</button>
    </div>
</div>

<div id="traded" role="region" aria-label="Trading completed" aria-live="assertive">
    <h3 class="mt-4">You have traded</h3>

    <p>You cannot make new offers in this trading period.</p>
    <p>Your profit in this trading period is <b>$<span id="profit"></span></b>.</p>
</div>


<h3 class="mt-4">Current market offers</h3>

<div class="row">
    <div class="col-6">
        <h4 id="asks-heading">Asks</h4>

        <div id="asks" class="offerbox border p-2 overflow-auto" role="region" aria-labelledby="asks-heading" aria-live="polite" aria-atomic="false"></div>
    </div>

    <div class="col-6">
        <h4 id="bids-heading">Bids</h4>

        <div id="bids" class="offerbox border p-2 overflow-auto" role="region" aria-labelledby="bids-heading" aria-live="polite" aria-atomic="false"></div>
    </div>
</div>


<h3 class="mt-4">Latest transactions</h3>

<div id="txs" class="offerbox border p-2 overflow-auto" role="region" aria-label="Latest transactions" aria-live="polite" aria-atomic="false"></div>

<!-- Instructions Modal -->
<div class="modal fade" id="instructionsModal" tabindex="-1" role="dialog" aria-labelledby="instructionsModalLabel" aria-describedby="instructionsModalBody" aria-hidden="true" aria-modal="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instructionsModalLabel">Instructions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close instructions modal"></button>
            </div>
            <div class="modal-body" id="instructionsModalBody">
                {% include 'double_auction/InstructionsText.html' %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-uproot" data-bs-dismiss="modal" aria-label="Close instructions">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock main %}


{% block late %}

<script>
    let buyer = {{ player.buyer | tojson }};
    let traded = {{ player.trade is not none | tojson }};
    let profit = {{ player.profit | tojson }};
    let offerAmount = uproot.vars.offer_amount;
    let market = {
        asks: [],
        bids: [],
        txs: [],
    };
</script>

<script src="{{ appstatic('trade.js') }}"></script>

{% endblock late %}
